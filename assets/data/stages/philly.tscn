[gd_scene load_steps=9 format=3 uid="uid://bwhsuvdq5edpw"]

[ext_resource type="Script" path="res://addons/parallax_node/parallax_node.gd" id="1_x2514"]
[ext_resource type="Texture2D" uid="uid://im65fthe3ecx" path="res://assets/images/stages/philly/sky.png" id="2_agrif"]
[ext_resource type="Texture2D" uid="uid://5stwalnt7ync" path="res://assets/images/stages/philly/city.png" id="3_otgl0"]
[ext_resource type="Texture2D" uid="uid://bf0r8njgp0bsn" path="res://assets/images/stages/philly/win.png" id="4_gvcbm"]
[ext_resource type="Texture2D" uid="uid://dijc3wyno6fju" path="res://assets/images/stages/philly/behindTrain.png" id="5_7hgyg"]
[ext_resource type="Texture2D" uid="uid://cvgppw4kvatwv" path="res://assets/images/stages/philly/train.png" id="6_81lcb"]
[ext_resource type="Texture2D" uid="uid://c5hls1381jcs7" path="res://assets/images/stages/philly/street.png" id="7_x3qcw"]

[sub_resource type="GDScript" id="GDScript_8icjw"]
script/source = "extends Node2D

# trainSound = new FlxSound().loadEmbedded(Paths.sound('train_passes'));
# FlxG.sound.list.add(trainSound);

# Called when the node enters the scene tree for the first time.
func _ready():
	pass # Replace with function body.


# Called every frame. 'delta' is the elapsed time since the previous frame.
func _process(delta):
#	if (trainMoving)
#	{
#		trainFrameTiming += elapsed;
#
#		if (trainFrameTiming >= 1 / 24)
#		{
#			updateTrainPos();
#			trainFrameTiming = 0;
#		}
#	}
#
#	lightFadeShader.update((Conductor.crochet / 1000) * FlxG.elapsed * 1.5);
	pass
\"\"\"
var trainMoving:Bool = false;
var trainFrameTiming:Float = 0;

var trainCars:Int = 8;
var trainFinishing:Bool = false;
var trainCooldown:Int = 0;

function trainStart():Void
{
	trainMoving = true;
	trainSound.play(true);
}

var startedMoving:Bool = false;

function updateTrainPos():Void
{
	if (trainSound.time >= 4700)
	{
		startedMoving = true;
		gf.playAnim('hairBlow');
	}

	if (startedMoving)
	{
		phillyTrain.x -= 400;

		if (phillyTrain.x < -2000 && !trainFinishing)
		{
			phillyTrain.x = -1150;
			trainCars -= 1;

			if (trainCars <= 0)
				trainFinishing = true;
		}

		if (phillyTrain.x < -4000 && trainFinishing)
			trainReset();
	}
}

function trainReset():Void
{
	gf.playAnim('hairFall');
	phillyTrain.x = FlxG.width + 200;
	trainMoving = false;
	// trainSound.stop();
	// trainSound.time = 0;
	trainCars = 8;
	trainFinishing = false;
	startedMoving = false;
}
\"\"\"

func beatHit():
	\"\"\"
	if (!trainMoving)
		trainCooldown += 1;

	if (curBeat % 4 == 0)
	{
		lightFadeShader.reset();

		phillyCityLights.forEach(function(light:FlxSprite)
		{
			light.visible = false;
		});

		curLight = FlxG.random.int(0, phillyCityLights.length - 1);

		phillyCityLights.members[curLight].visible = true;
		// phillyCityLights.members[curLight].alpha = 1;
	}

	if (curBeat % 8 == 4 && FlxG.random.bool(30) && !trainMoving && trainCooldown > 8)
	{
		trainCooldown = FlxG.random.int(-4, 0);
		trainStart();
	}
\"\"\"
	pass
"

[node name="philly" type="Node2D"]
script = SubResource("GDScript_8icjw")

[node name="scroll 0_1" type="Node2D" parent="."]
script = ExtResource("1_x2514")
parallax_factor = Vector2(0.1, 0.1)

[node name="BG" type="Sprite2D" parent="scroll 0_1"]
position = Vector2(-100, 0)
texture = ExtResource("2_agrif")
centered = false

[node name="scroll 0_3" type="Node2D" parent="."]
position = Vector2(-10, 0)
script = ExtResource("1_x2514")
parallax_factor = Vector2(0.3, 0.3)

[node name="City" type="Sprite2D" parent="scroll 0_3"]
position = Vector2(-10, 0)
scale = Vector2(0.85, 0.85)
texture = ExtResource("3_otgl0")
centered = false

[node name="Philly City Lights" type="Node2D" parent="scroll 0_3"]
position = Vector2(10, 0)

[node name="Win0" type="Sprite2D" parent="scroll 0_3/Philly City Lights"]
position = Vector2(-10, 0)
scale = Vector2(0.85, 0.85)
texture = ExtResource("4_gvcbm")
centered = false

[node name="Win1" type="Sprite2D" parent="scroll 0_3/Philly City Lights"]
position = Vector2(-10, 0)
scale = Vector2(0.85, 0.85)
texture = ExtResource("4_gvcbm")
centered = false

[node name="Win2" type="Sprite2D" parent="scroll 0_3/Philly City Lights"]
position = Vector2(-10, 0)
scale = Vector2(0.85, 0.85)
texture = ExtResource("4_gvcbm")
centered = false

[node name="Win3" type="Sprite2D" parent="scroll 0_3/Philly City Lights"]
position = Vector2(-10, 0)
scale = Vector2(0.85, 0.85)
texture = ExtResource("4_gvcbm")
centered = false

[node name="Win4" type="Sprite2D" parent="scroll 0_3/Philly City Lights"]
position = Vector2(-10, 0)
scale = Vector2(0.85, 0.85)
texture = ExtResource("4_gvcbm")
centered = false

[node name="Win5" type="Sprite2D" parent="scroll 0_3/Philly City Lights"]
position = Vector2(-10, 0)
scale = Vector2(0.85, 0.85)
texture = ExtResource("4_gvcbm")
centered = false

[node name="Street Behind" type="Sprite2D" parent="."]
position = Vector2(-40, 50)
texture = ExtResource("5_7hgyg")
centered = false

[node name="Philly Train" type="Sprite2D" parent="."]
position = Vector2(2000, 360)
texture = ExtResource("6_81lcb")
centered = false

[node name="Street" type="Sprite2D" parent="."]
position = Vector2(-40, 50)
texture = ExtResource("7_x3qcw")
centered = false
